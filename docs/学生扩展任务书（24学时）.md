# 学生扩展任务书（24 学时）

## 一、目标与原则
- 目标：在完成基础功能的前提下，独立实现若干扩展特性，强化端到端思维与工程能力。
- 原则：小步快跑、可演示、可验收；每个扩展具有明确的输入、输出与验收标准。

## 二、学时规划（8 次课 × 3 学时）
1. 扩展总览与分工（3 学时）：选定 3–5 个扩展，明确验收标准与接口设计
2. 登录体验优化（3 学时）：失败提示、表单校验、前端错误展示规范
3. 课程筛选与分页（3 学时）：课程列表支持分页与组合过滤（学分区间 + 星期）
4. 冲突高亮与可视化（3 学时）：在 `students.html` 高亮冲突时间段，或在选课时提示冲突原因
5. CSV 导出增强（3 学时）：增加表头、时间戳、分隔符选择，下载按钮与成功提示
6. 日志查询增强（3 学时）：新增条件查询（按用户、动作类型、时间范围），结果分页
7. 推荐算法增强（3 学时）：引入“相似课程”或“最近新增优先”，保留热度排序为兜底
8. 收尾与演示（3 学时）：统一风格与文档，完成扩展演示与验收

## 三、推荐扩展项与验收标准
1. 密码重置流程模拟（无需邮件服务）
   - 后端改动：在 `UserServlet` 增加 `reset_password` 支持 `username/code/newPassword` 参数；固定验证码或简单规则（如 `code == "0000"`）
   - 前端改动：在 `index.html` 增加“重置密码”表单与提示区域；失败展示统一红色错误框
   - 验收步骤：输入用户名+验证码+新密码 → 返回 `{ok:true}`；错误验证码返回 `{ok:false, code, message}` 并在页面展示
2. 课程分页与组合过滤
   - 后端改动：`CourseServlet?action=list` 支持 `page/size`；`filter` 支持 `minCredit/maxCredit/day`
   - 前端改动：在 `courses.html` 增加分页控件（上一页/下一页）与筛选表单；每次请求更新表格
   - 验收步骤：不同参数组合结果正确；分页翻页数据变化，边界页禁用按钮
3. 选课冲突提示增强
   - 后端改动：`EnrollServlet?action=enroll` 在冲突时返回冲突课程名与时间段 `{reason:"与[操作系统] 周三 14:00-16:00 冲突"}`
   - 前端改动：在 `enroll.html` 选课失败时于表格上方展示冲突明细；同时高亮冲突行
   - 验收步骤：构造冲突课程后选课 → 前端展示明细与高亮；非冲突时不展示
4. CSV 导出内容优化
   - 后端改动：`StudentServlet?action=grades_export` 首行写表头 `课程,学分,成绩` 与生成时间；文件名 `grades-YYYYMMDD-HHMM.csv`
   - 前端改动：在 `students.html` 导出按钮附近增加“导出成功/失败”提示；点击后触发下载或显示保存路径
   - 验收步骤：导出的 CSV 含表头与时间戳，能在 Excel 正常打开
5. 管理员日志查询增强
   - 后端改动：`AdminServlet?action=logs_query` 支持 `user/action/from/to/page/size`
   - 前端改动：在 `admin.html` 增加查询条件与分页控件；表格显示总条数与当前页
   - 验收步骤：可按用户或动作类型筛选，支持时间范围与分页，返回总条数字段
6. 课程推荐增强
   - 后端改动：通过 `CourseDao.recommend(userId)` 的底层评分调整（默认委托 `Db.recommend`），加入“新课优先”（过去 24 小时新增课程权重提升）
   - 前端改动：在 `students.html` 推荐卡片处说明“新课优先”策略；列表按新课权重+热度排序
   - 验收步骤：新增课程在推荐列表靠前；无新增课程时回退为热度排序

## 四、推荐扩展项示例代码（后端 + 前端）

说明：以下示例全部基于项目真实代码风格（后端成功直接返回数据，失败抛 `lwWebException(code, reason)`，由 `SimpleRestful` 统一输出 `error/reason/data`）。前端统一用 `LW.rest(url, payload)` 并以 `ans.error==0` 判断成功。

### 1. 密码重置流程模拟（无需邮件服务）
- 后端（`UserServlet`）
```java
case "reset_password":{
    String username=jreq.getString("username");
    String code=jreq.getString("code");
    String newPwd=jreq.getString("newPassword");
    if(!"0000".equals(code)) throw new lw.web.lwWebException(400, "验证码错误");
    boolean ok=com.training.dao.DaoFactory.user().resetPassword(username,newPwd);
    if(!ok) throw new lw.web.lwWebException(404, "用户不存在");
    return new org.json.JSONObject().put("ok", true);
}
```
- 前端（`index.html`）
```js
async function doReset(){
  const username=$('#username').value, code=$('#code').value, newPassword=$('#newpwd').value;
  const ans=await LW.rest('/UserServlet', {action:'reset_password', username, code, newPassword});
  if(ans.error!=0) return showError(ans.reason);
  showOk('密码已重置');
}
```

### 2. 课程分页与组合过滤
- 后端（`CourseServlet` 的 `list` 与 `filter`）
```java
case "list":{
    int page=jreq.has("page")? jreq.getInt("page"):1;
    int size=jreq.has("size")? jreq.getInt("size"):10;
    java.util.List<com.training.db.Db.Course> all=com.training.dao.DaoFactory.course().listCourses();
    int from=Math.max(0,(page-1)*size), to=Math.min(all.size(), from+size);
    org.json.JSONArray items=new org.json.JSONArray();
    for(int i=from;i<to;i++) items.put(toJson(all.get(i))); // 复用已有 toJson(c)
    org.json.JSONObject out=new org.json.JSONObject();
    out.put("items", items); out.put("total", all.size());
    return out;
}
case "filter":{
    Integer min=jreq.has("minCredit")? jreq.getInt("minCredit"):null;
    Integer max=jreq.has("maxCredit")? jreq.getInt("maxCredit"):null;
    String day=jreq.optString("day", null);
    java.util.List<com.training.db.Db.Course> list=com.training.dao.DaoFactory.course().filterCourses(min,max,day);
    org.json.JSONArray arr=new org.json.JSONArray();
    for(com.training.db.Db.Course c: list) arr.put(toJson(c));
    return arr;
}
```
- 前端（`courses.html`）
```js
async function loadPage(page=1){
  const ans=await LW.rest('/CourseServlet', {action:'list', page, size:10});
  if(ans.error!=0) return showError(ans.reason);
  const {items,total}=ans.data; renderTable(items); renderPager(page, Math.ceil(total/10));
}
async function onFilter(){
  const q={minCredit:getMin(), maxCredit:getMax(), day:getDay()};
  const ans=await LW.rest('/CourseServlet', {action:'filter', ...q});
  if(ans.error!=0) return showError(ans.reason);
  renderTable(ans.data);
}
```

### 3. 选课冲突提示增强
- 后端（`EnrollServlet`，在 `enroll` 分支加入冲突明细）
```java
case "enroll":{
    String courseId=jreq.getString("courseId");
    // 先尝试构造冲突明细（便于返回 reason）
    com.training.db.Db.Course target=null; for(com.training.db.Db.Course c: com.training.dao.DaoFactory.course().listCourses()) if(c.id.equals(courseId)) {target=c;break;}
java.util.List<com.training.db.Db.Enrollment> mine=com.training.dao.DaoFactory.enrollment().listUserEnrollments(uid);
java.util.Map<String,com.training.db.Db.Course> id2c=new java.util.HashMap<>(); for(com.training.db.Db.Course c: com.training.dao.DaoFactory.course().listCourses()) id2c.put(c.id,c);
    if(target!=null){
        for(com.training.db.Db.Enrollment e: mine){ if(!"enrolled".equals(e.status)) continue; com.training.db.Db.Course cur=id2c.get(e.courseId); if(cur==null) continue;
            for(com.training.db.Db.TimeSlot t1:cur.times) for(com.training.db.Db.TimeSlot t2:target.times){
                if(t1.day.equals(t2.day) && !(t1.end<=t2.start || t2.end<=t1.start)){
                    String reason="与["+cur.name+"] "+t2.day+" "+t2.start+":00-"+t2.end+":00 冲突";
                    throw new lw.web.lwWebException(409, reason);
                }
            }
        }
    }
    // 无显式冲突则走原有 enroll 逻辑（容量/候补与并发锁在 Db 内部）
    com.training.db.Db.Enrollment e=com.training.dao.DaoFactory.enrollment().enroll(uid, courseId);
    if(e==null) throw new lw.web.lwWebException(404, "课程不存在");
    return new org.json.JSONObject().put("status", e.status);
}
```
- 前端（`enroll.html`）
```js
async function doEnroll(courseId){
  const ans=await LW.rest('/EnrollServlet', {action:'enroll', courseId});
  if(ans.error!=0){ showError(ans.reason); highlightRow(courseId); return; }
  showOk('选课成功，状态：'+ans.data.status);
}
```

### 4. CSV 导出内容优化
- 后端（`StudentServlet` 的 `grades_export`）
```java
case "grades_export":{
    java.util.List<com.training.db.Db.Grade> list=com.training.dao.DaoFactory.grade().getGrades(uid);
    String now=new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm").format(new java.util.Date());
    StringBuilder sb=new StringBuilder();
    sb.append("# 生成时间,").append(now).append("\n");
    sb.append("课程,分数\n");
    for(com.training.db.Db.Grade g: list){ sb.append(g.courseName!=null? g.courseName: g.courseId).append(",").append(g.score).append("\n"); }
    String real=req.getServletContext().getRealPath("/exports"); java.io.File dir=new java.io.File(real); if(!dir.exists()) dir.mkdirs();
    String fname="grades-"+new java.text.SimpleDateFormat("yyyyMMdd-HHmm").format(new java.util.Date())+".csv";
    java.io.File f=new java.io.File(dir, fname);
    lw.util.TextFile.write(f, sb.toString(), charset);
    java.util.Map<String,Object> r=new java.util.HashMap<>(); r.put("file", "/exports/"+f.getName()); return r;
}
```
- 前端（`students.html`）
```js
async function exportGrades(){
  const ans=await LW.rest('/StudentServlet', {action:'grades_export'});
  if(ans.error!=0) return showError(ans.reason);
  showOk('导出成功'); window.location.href=ans.data.file;
}
```

### 5. 管理员日志查询增强
- 后端（`AdminServlet` 的 `logs_query`）
```java
case "logs_query":{
    String user=jreq.optString("user", null);
    String action=jreq.optString("action", null);
    int page=jreq.has("page")? jreq.getInt("page"):1;
    int size=jreq.has("size")? jreq.getInt("size"):10;
    java.util.List<String> logs=com.training.dao.DaoFactory.admin().getLogs();
    java.util.List<String> filtered=new java.util.ArrayList<>();
    for(String line: logs){
        if(user!=null && !line.contains(user)) continue; // 简单包含判断
        if(action!=null && !line.startsWith(action)) continue; // 前缀匹配动作
        filtered.add(line);
    }
    int from=Math.max(0,(page-1)*size), to=Math.min(filtered.size(), from+size);
    java.util.Map<String,Object> out=new java.util.HashMap<>();
    out.put("items", filtered.subList(from, to)); out.put("total", filtered.size());
    return out;
}
```
- 前端（`admin.html`）
```js
async function queryLogs(q){
  const ans=await LW.rest('/AdminServlet', {action:'logs_query', ...q});
  if(ans.error!=0) return showError(ans.reason);
  renderLogs(ans.data.items); renderPager(q.page||1, Math.ceil(ans.data.total/(q.size||10)));
}
```

### 6. 课程推荐增强（新课优先）
- 后端（修改 `Db`：记录新增时间并在 `recommend` 提升权重）
```java
// 在 Db 类中新增：
private static final java.util.Map<String,Long> courseAddTime=new java.util.concurrent.ConcurrentHashMap<>();

// 在 addCourse 内记录：
public static Course addCourse(String name,int credit,int capacity,java.util.List<TimeSlot> times){
    String id=uuid(); Course c=new Course(id,name,credit,capacity,times);
    courses.put(id,c); courseLocks.put(id,new java.util.concurrent.locks.ReentrantLock());
    courseAddTime.put(id, System.currentTimeMillis()); log("addCourse:"+name);
    return c;
}

// 在 recommend 内增加“新课优先”权重：
public static java.util.List<Course> recommend(String userId){
    java.util.Map<String,Integer> popularity=new java.util.HashMap<>();
    for(java.util.List<Enrollment> list: enrollmentsByUser.values()) for(Enrollment e:list){ popularity.put(e.courseId, popularity.getOrDefault(e.courseId,0)+1);}        
    java.util.Set<String> taken=new java.util.HashSet<>(); for(Enrollment e: enrollmentsByUser.getOrDefault(userId,new java.util.ArrayList<>())) taken.add(e.courseId);
    java.util.List<Course> out=new java.util.ArrayList<>();
    for(Course c: courses.values()) if(!taken.contains(c.id)) out.add(c);
    final long now=System.currentTimeMillis(), ONE_DAY=24L*3600*1000;
    out.sort((a,b)->{
        int pa=popularity.getOrDefault(a.id,0), pb=popularity.getOrDefault(b.id,0);
        long ta=courseAddTime.getOrDefault(a.id,0L), tb=courseAddTime.getOrDefault(b.id,0L);
        int wa=(now-ta<ONE_DAY)? 100:0; // 新课加权 100 分
        int wb=(now-tb<ONE_DAY)? 100:0;
        return (pb+wb) - (pa+wa);
    });
    return out;
}
```
- 前端（`students.html`）
```js
async function loadRecommend(){
  const ans=await LW.rest('/StudentServlet', {action:'recommend'});
  if(ans.error!=0) return showError(ans.reason);
  renderRecommend(ans.data); // 后端已按权重排序
}
```

提示：以上示例仅展示“如何改”，不强制你完全一致。实现时请保持后端统一响应格式与前端 `error==0` 判断的一致性，并为失败原因提供清晰的 `reason`。

## 五、提交物与评分建议
- 提交物：扩展代码、变更说明、演示视频或截图、更新后的《操作手册》片段
- 评分建议：
  - 扩展完成度（40%）
  - 代码质量与一致性（20%）
  - 可视化与用户体验（20%）
  - 文档与演示（20%）

## 六、里程碑检查表
- 每个扩展均有：接口说明、参数示例、返回示例、前端调用与展示、失败场景说明
- 运行无阻碍：所有页面与接口均能访问，日志与 CSV 功能可用
- 可验收：每项扩展有“如何验收”的明确步骤与期望结果

## 七、开发约定：DAO 分层（新增）
- 为保持与存储实现解耦，所有扩展建议通过 `DaoFactory` 访问数据：
```java
var U = com.training.dao.DaoFactory.user();
var C = com.training.dao.DaoFactory.course();
var E = com.training.dao.DaoFactory.enrollment();
var G = com.training.dao.DaoFactory.grade();
var A = com.training.dao.DaoFactory.admin();
```
- 验收建议：扩展实现中不直接调用 `Db.*`，而是通过相应 DAO；如需替换为数据库实现，仅需实现同名接口并在工厂中切换绑定。