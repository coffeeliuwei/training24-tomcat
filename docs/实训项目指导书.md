# 实训项目指导书（training24-tomcat）

## 一、导入与运行
- 导入项目：Eclipse > File > Import > Existing Projects into Workspace
- 运行时绑定：Targeted Runtimes 勾选 `Apache Tomcat v8.5`
- Facets：`Dynamic Web Module 3.1`，`Java 1.8`
- 访问：`http://localhost:8080/training24-tomcat/`

## 二、请求处理总览（面向初学者）
- Servlet 生命周期：容器实例化 → `init()` → 处理请求（`doGet/doPost`）→ `destroy()`
- URL 入口示例：`/UserServlet?action=login&username=...&password=...`
- 参数解析统一：使用 `lwFormData` 获取文本与数字（避免手写 `request.getParameter`）：
```
lwFormData f = new lwFormData(request);
String action = f.getText("action");
String username = f.getText("username");
int page = f.getInt("page", 1);
```
- 统一响应：通过 `SimpleRestful.ok(data)` 返回成功，`SimpleRestful.fail(code, message)` 返回失败，前端只需判断 `ok` 字段：
```
return SimpleRestful.ok(db.listCourses());
// 或
return SimpleRestful.fail(400, "参数错误");
```
- 补充说明（实际代码实现，初学者必读）：上述 `ok/fail` 为概念化描述，当前项目实际采用“成功直接 return 数据；失败抛出 `lwWebException(code, reason)`”，由 `SimpleRestful` 基类统一格式化为 `{"error":0,"reason":"ok","data":...}` 或 `{"error":code,"reason":message}`。前端判断 `error==0` 即成功：
```
return db.listCourses();
// 或（失败时）
throw new lwWebException(400, "参数错误");
```
- 会话使用：登录成功后，将用户放入 `HttpSession`，后续接口通过 Session 识别当前用户：
```
HttpSession s = request.getSession();
s.setAttribute("user", user);
User current = (User) s.getAttribute("user");
```
- 统一异常：业务中抛出 `lwWebException(code, message)`，框架在顶层捕获并输出统一失败格式。

## 三、核心类与职责（代码走读）
- `Db`（内存数据库，线程安全）：提供实体与操作
  - 实体类：`User(id,username,password,role,email)`、`Course(id,name,credit,capacity,enrolled,times)`、`TimeSlot(day,start,end,date?)`、`Enrollment(userId,courseId,status)`、`Grade(userId,courseId,score,courseName)`
  - 用户：`addUser(username,password,role,email)`、`findUserByName(username)`、`auth(username,password)`、`resetPassword(username,newPwd)`
  - 课程：`addCourse(name,credit,capacity,times)`、`updateCourse(id,name?,credit?,capacity?,times?)`、`deleteCourse(id)`、`listCourses()`、`filterCourses(minCredit?,maxCredit?,day?)`
  - 选课与候补：`enroll(userId,courseId)`（返回 `Enrollment`，可能 `enrolled/waitlist/conflict`）、`drop(userId,courseId)`（退课并可能候补转正）、`listUserEnrollments(userId)`；内部私有 `conflict(userId,Course)` 进行时间冲突检测，`courseLocks` 保证并发一致
  - 学生数据：`calendar(userId)`（返回简化日历事件）、`setGrade(userId,courseId,score)`、`getGrades(userId)`、`recommend(userId)`（按热度推荐未选课程）
  - 系统：`log(text)`、`getLogs()`、`stats()`（用户、课程、选课总数）、`seed()`（初始化示例数据）
- `lwFormData`：从 `HttpServletRequest` 解析参数，提供 `getText/getInt` 等方法，含默认值支持
- `SimpleRestful`：响应封装，统一输出 `{"error":0,"reason":"ok","data":...}` 或 `{"error":code,"reason":message}`
- `TextFile`：CSV 写文件工具，用于 `export_csv`

### 选课流程（真实代码，附注释）
```java
// EnrollServlet.java 中的选课相关片段（真实代码）
@Override
protected Object execute(HttpServletRequest req, HttpServletResponse resp, org.json.JSONObject jreq) throws Exception {
    // 1) 会话校验：必须已登录，读取 uid
    javax.servlet.http.HttpSession s = req.getSession(false); if (s==null) throw new lw.web.lwWebException(401, "未登录");
    String uid = (String)s.getAttribute("uid"); if (uid==null) throw new lw.web.lwWebException(401, "未登录");
    String action = jreq!=null ? jreq.optString("action", "") : "";
    switch(action){
        case "enroll":{
            // 2) 从请求体读取课程ID
            String courseId = jreq.getString("courseId");
            // 3) 调用 Db.enroll() 进行容量/冲突/候补处理
            com.training.db.Db.Enrollment e = com.training.db.Db.enroll(uid, courseId);
            if (e==null) throw new lw.web.lwWebException(404, "课程不存在");
            // 4) 返回统一 data：仅包含状态（enrolled/waitlist/conflict）
            return new org.json.JSONObject().put("status", e.status);
        }
        case "drop":{
            String courseId = jreq.getString("courseId");
            boolean ok = com.training.db.Db.drop(uid, courseId);
            return new org.json.JSONObject().put("ok", ok);
        }
        case "mylist":{
            java.util.List<com.training.db.Db.Enrollment> list = com.training.db.Db.listUserEnrollments(uid);
            java.util.List<com.training.db.Db.Course> all = com.training.db.Db.listCourses();
            org.json.JSONArray arr = new org.json.JSONArray();
            for(com.training.db.Db.Enrollment e : list){
                org.json.JSONObject je = new org.json.JSONObject();
                je.put("userId", e.userId);
                je.put("courseId", e.courseId);
                je.put("status", e.status);
                String name=null; for(com.training.db.Db.Course c: all){ if(c.id.equals(e.courseId)){ name=c.name; break; } }
                if(name!=null) je.put("name", name);
                arr.put(je);
            }
            return arr;
        }
        default: throw new lw.web.lwWebException(400, "未知action:"+action);
    }
}
```
- 冲突与容量：`Db.enroll(userId, courseId)` 内部先做时间冲突检查（`conflict(userId,Course)`），未满员则直接 `enrolled`，满员加入候补 `waitlist`。所有操作在课程级锁 `courseLocks` 下保证并发安全，并写入日志。
- 退课与转正：`Db.drop(userId, courseId)` 成功后会减少课程已选人数；若存在候补队列，自动将队首转为已选并记录 `promote` 日志。
- 我的选课：`Db.listUserEnrollments(uid)` 返回当前用户的所有选课记录，接口补充课程名，便于前端直接展示。
- 统计输出：`Db.stats()` 返回 `Map<String,Object>`，包含用户数、课程数、选课总数。

## 四、前端交互与约定（示例页面）
- `index.html`：登录/注册表单，调用 `UserServlet?action=login/register`
- `enroll.html`：选课列表与操作按钮
  - “已选”列显示逻辑：
    - 管理员：显示课程已选总人数（来自 `AdminServlet` 或课程列表统计）
    - 学生：显示 `是/否`（是否在我的选课列表中）；未加载完前显示 `—`
  - 角色检测：`detectAdmin(cb)` 完成后回调再渲染，避免学生误显示管理员统计
- `courses.html`：课程创建/更新/删除，过滤 `minCredit/maxCredit/day`
- `students.html`：课表事件列表、成绩、推荐，CSV 导出按钮（触发 `export_csv`）
- `admin.html`：展示 `stats` 与 `logs_query` 的结果

## 五、统一风格与约定
- 接口参数统一使用 `action` 指定具体操作
- JSON 返回统一包含 `ok` 字段，前端只需 `if(resp.ok){...}else{...}`
- 日志统一调用 `Db.log(user, action, detail)`，便于管理员查询
- 错误码建议：400 参数错误、401 未登录、403 无权限、404 不存在、409 业务冲突、500 内部错误

## 六、循序渐进实现顺序（建议）
1. 启动与种子数据：在首次访问时调用 `Db.seed()` 初始化若干课程与用户
2. 用户模块：注册、登录、注销、重置密码（Session 放置用户对象）
3. 课程模块：创建/更新/删除与过滤（前端联动刷新）
4. 选课模块：选课/退课/候补转正，前端列表联动与冲突提示
5. 学生模块：课表、成绩、推荐、CSV 导出
6. 管理员模块：统计与日志查询

## 七、联调与演示顺序（建议）
- 访问 `index.html` 完成注册与登录
- 管理员进入 `courses.html` 创建/更新/删除课程
- 学生进入 `enroll.html` 选课与退课（观察候补与转正）
- 在 `students.html` 查看课表/成绩/推荐，导出 CSV
- 在 `admin.html` 查看统计与日志

## 八、常见问题与排查
- 404：检查上下文根是否为 `training24-tomcat`，Servlet 是否映射正确
- 500：查看日志与异常信息，统一失败格式来源于 `lwWebException`
- CSV 路径：确认 `WebRoot/exports/` 目录存在且可写
- JDK/Facet：确保项目使用 `JavaSE-1.8` 与 `Dynamic Web Module 3.1`

## 九、代码规范与注释（面向初学者）
- 注释原则：解释“为什么这样做”和“输入/输出是什么”，避免只复述代码
- Servlet 顶部注释：说明职责、入口参数（action）、返回结构与示例
- 复杂分支：在冲突判断、候补转正处加入行级注释
- 前端：在发起请求处标注“请求参数来源”“响应展示位置”，如“已选列渲染逻辑”注释

## 十、DAO 分层设计（新增）
- 目的：抽象数据访问，默认使用“内存实现”，可替换为持久化实现（如 MySQL）。
- 接口位置：`src/com/training/dao/*.java`
  - `UserDao`：`addUser/findByName/resetPassword/auth`
  - `CourseDao`：`addCourse/updateCourse/deleteCourse/listCourses/filterCourses`
  - `EnrollmentDao`：`enroll/drop/listUserEnrollments/calendar`
  - `GradeDao`：`setGrade/getGrades`
  - `AdminDao`：`stats/log/getLogs`
- 默认实现：`src/com/training/dao/memory/*.java`（全部委托 `Db` 静态方法）
- 工厂获取：`src/com/training/dao/DaoFactory.java`
```java
var U = com.training.dao.DaoFactory.user();
var C = com.training.dao.DaoFactory.course();
var E = com.training.dao.DaoFactory.enrollment();
var G = com.training.dao.DaoFactory.grade();
var A = com.training.dao.DaoFactory.admin();
// 示例：登录
var user = U.auth(username, password);
// 示例：课程列表
var list = C.listCourses();
```
- 重构建议：后续将各 Servlet 中对 `Db.*` 的直接调用替换为 `DaoFactory.*`，以实现与存储实现解耦。