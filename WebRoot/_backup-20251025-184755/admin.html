<!DOCTYPE html>
<!-- 初学者说明：本页用于管理员查看系统统计与日志。
- 依赖接口：AdminServlet（前端通过 LW.rest 使用 `api/admin` 路径）
  - `action=stats` 返回系统统计（JSON），显示在 <pre id="stats"> 中
  - `action=logs_query` 返回日志列表（数组），支持分页展示
- 页面结构：顶部导航 → 统计报表卡片 → 日志查询卡片（含分页控件）
- 学习建议：先理解 HTML 结构与各 id 对应的元素，然后看最下方 <script> 里的事件绑定与数据渲染流程。
-->
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>管理员工具</title>
<!-- 资源引入：
- assets/style.css：页面样式（卡片、导航、表格等）
- jQuery：简化 DOM 操作与 Ajax
- assets/lwquery.js：对后端 REST 接口的轻量封装（LW.rest）
-->
<link rel="stylesheet" href="assets/style.css" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="assets/lwquery.js"></script>
</head>
<body>
<header>
  <!-- 顶部导航：用于在不同页面间跳转（登录、课程、选课、学生、管理员） -->
  <nav>
    <a href="index.html">登录/注册</a>
    <a href="courses.html">课程管理/查询</a>
    <a href="enroll.html">选课</a>
    <a href="students.html">学生视图</a>
    <a href="admin.html">管理员</a>
  </nav>
</header>
<main>
  <!-- 统计报表：通过调用 `action=stats` 获取数据并以 JSON 形式展示 -->
  <div class="card">
    <h3>统计报表</h3>
    <div class="error" id="err-admin" style="display:none;color:#b00020;background:#ffecec;padding:6px;margin:6px 0;"></div>
    <pre id="stats"></pre>
  </div>
  <!-- 日志查询：通过 `action=logs_query` 获取日志列表，使用下方分页控件翻页 -->
  <div class="card">
    <h3>日志查询</h3>
    <ul id="logs"></ul>
    <div class="pager" id="pager-logs" style="margin-top:8px;">
      <button class="btn" id="pl-prev">上一页</button>
      <span id="pl-info" style="margin:0 8px;">第 1 / 1 页，共 0 条</span>
      <button class="btn" id="pl-next">下一页</button>
      <span style="margin-left:12px;">每页</span>
      <select id="pl-size">
        <option>10</option>
        <option selected>20</option>
        <option>50</option>
      </select>
    </div>
  </div>
</main>
<script>
/* 脚本总览（建议先通读）：
- showErrAdmin：统一错误提示（显示后3秒自动隐藏）
- logsAll/plPage/plSize：日志数据与分页状态（当前页/每页大小）
- renderLogsPage：根据分页状态渲染当前页日志到 <ul id="logs">
- requireAdmin：调用后端接口获取统计与日志；若需要鉴权，后端会返回错误
- 分页事件：上一页/下一页/每页大小改变时更新状态并重新渲染
- 页面加载：$(function(){ ... }) 文档就绪时自动调用 requireAdmin()
*/
// 统一错误提示框（3秒自动消失）
function showErrAdmin(msg){ var box=$('#err-admin'); box.text(msg).show(); setTimeout(function(){ box.fadeOut(200); }, 3000); }
// 日志数据与分页状态（plPage：当前页；plSize：每页条数）
var logsAll=[], plPage=1, plSize=20;
// 根据当前分页状态，将 logsAll 渲染到列表
function renderLogsPage(){
  var total=logsAll.length; var max=Math.max(1, Math.ceil(total/plSize));
  plPage=Math.min(plPage, max);
  var start=(plPage-1)*plSize; var items=logsAll.slice(start, start+plSize);
  var ul=$('#logs'); ul.empty();
  items.forEach(function(l){ ul.append('<li>'+l+'</li>'); });
  $('#pl-info').text('第 '+plPage+' / '+max+' 页，共 '+total+' 条');
}
// 拉取统计与日志（调用后端 AdminServlet 对应接口），并进行初次渲染
function requireAdmin(){
  LW.rest('api/admin', {action:'stats'}, function(data){ $('#stats').text(JSON.stringify(data, null, 2)); }, function(e,r){ showErrAdmin(r); });
  LW.rest('api/admin', {action:'logs_query'}, function(list){ logsAll=list||[]; plPage=1; renderLogsPage(); }, function(e,r){ showErrAdmin(r); });
}
// 分页事件：上一页/下一页/每页大小改变
$('#pl-prev').on('click', function(){ if(plPage>1){ plPage--; renderLogsPage(); } });
$('#pl-next').on('click', function(){ var max=Math.max(1, Math.ceil(logsAll.length/plSize)); if(plPage<max){ plPage++; renderLogsPage(); } });
$('#pl-size').on('change', function(){ plSize = Number($(this).val()); plPage = 1; renderLogsPage(); });
// 文档就绪：加载统计与日志
$(function(){ requireAdmin(); });
</script>
</body>
</html>