<!DOCTYPE html>
<!-- 初学者说明：学生视图，包含课表、成绩与推荐，并支持导出成绩CSV。
- 依赖接口：
  - 学生：StudentServlet（`api/student`）`action=calendar|grades|recommend|grades_export`
  - 课程：CourseServlet（`api/course`）`action=list`（用于展示成绩时补全课程名）
- 页面结构：导航 → 三个卡片（课表/成绩/推荐）→ 脚本逻辑
- 学习建议：先理解三个表格/列表的 HTML 结构，再看脚本中每个模块的加载函数。
-->
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>学生视图</title>
<!-- 资源引入：样式 + jQuery + LW 封装（统一后端交互） -->
<link rel="stylesheet" href="assets/style.css" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="assets/lwquery.js"></script>
</head>
<body>
<header>
  <!-- 顶部导航：学生常用入口，包含课表、成绩与推荐功能 -->
  <nav>
    <a href="index.html">登录/注册</a>
    <a href="courses.html">课程管理/查询</a>
    <a href="enroll.html">选课</a>
    <a href="students.html">学生视图</a>
    <a href="admin.html">管理员</a>
  </nav>
</header>
<main>
  <!-- 学生课表：将同一课程的多个时间段合并为一行，避免重复显示 -->
  <div class="card">
    <h3>学生课表（日历视图简化）</h3>
    <table class="table" id="tbl-cal"><thead><tr><th>课程</th><th>时间</th></tr></thead><tbody></tbody></table>
  </div>
  <!-- 成绩单：显示课程名称与成绩；支持导出 CSV 文件 -->
  <div class="card">
    <h3>成绩单</h3>
    <table class="table" id="tbl-grade"><thead><tr><th>课程名称</th><th>成绩</th></tr></thead><tbody></tbody></table>
    <div class="error" id="err-students" style="display:none;color:#b00020;background:#ffecec;padding:6px;margin:6px 0;"></div>
    <button class="btn" id="btn-export">导出CSV</button> <span id="export-link"></span>
  </div>
  <!-- 课程推荐：展示推荐课程（后端已稳定排序）；可展开原始数据便于学习观察 -->
  <div class="card">
    <h3>课程推荐</h3>
    <ul id="rec"></ul>
    <small id="rec-empty" style="color:#666;display:none;">暂无推荐（已选全部课程或暂无候选）</small>
    <pre id="rec-raw" style="display:none;background:#f7f7f7;padding:8px;border:1px dashed #ccc;color:#333"></pre>
  </div>
</main>
<script>
/* 脚本总览：
- showErrStudents：统一错误提示（自动隐藏）
- loadCal：拉取课表，按课程名合并多个时间段
- loadGrades：先拉取课程列表构建映射，再拉取成绩并显示课程名称与分数；失败时回退
- loadRec：拉取推荐，若为空显示提示；同时展示原始 JSON 便于学习
- 导出按钮：调用 `grades_export` 返回文件路径，生成下载链接
- 页面加载：文档就绪时并行拉取三类数据
*/
// 错误提示
function showErrStudents(msg){ var box=$('#err-students'); box.text(msg).show(); setTimeout(function(){ box.fadeOut(200); }, 3000); }
// 加载课表并合并显示
function loadCal(){
  LW.rest('api/student', {action:'calendar'}, function(list){
    var tb=$('#tbl-cal tbody'); tb.empty();
    // 将同一课程的多个时间段合并为一行，避免重复
    var byTitle={}; (list||[]).forEach(function(e){ (byTitle[e.title]||(byTitle[e.title]=[])).push(e); });
    Object.keys(byTitle).forEach(function(title){
      var times=byTitle[title].map(function(ev){ return ev.day+' '+ev.start+'-'+ev.end; }).join('; ');
      var tr=$('<tr/>'); tr.append('<td>'+title+'</td>'); tr.append('<td>'+times+'</td>'); tb.append(tr);
    });
  }, function(e,r){ showErrStudents(r); });
}
// 加载成绩（优先用课程列表补全名称）
function loadGrades(){
  // 先取课程列表，构造 courseId->name 映射，确保显示课程名称
  LW.rest('api/course', {action:'list'}, function(courses){
    var cmap={}; (courses||[]).forEach(function(c){ if(c && (c.id || c.courseId)){ var key = c.id || c.courseId; cmap[key] = c.name || c.title || c.courseName; } });
    LW.rest('api/student', {action:'grades'}, function(list){
      var tb=$('#tbl-grade tbody'); tb.empty();
      (list||[]).forEach(function(e){
        var name = (e && (e.name || cmap[e.courseId] || e.title || e.courseName)) || e.courseId;
        var score = (e && e.score!=null) ? e.score : '';
        tb.append('<tr><td>'+name+'</td><td>'+score+'</td></tr>');
      });
    }, function(e,r){ showErrStudents(r); });
  }, function(e,r){
    // 课程列表失败时回退为直接渲染（仍尽量显示名称字段）
    LW.rest('api/student', {action:'grades'}, function(list){
      var tb=$('#tbl-grade tbody'); tb.empty();
      (list||[]).forEach(function(e){
        var name = e && (e.name || e.title || e.courseName || e.courseId);
        var score = (e && e.score!=null) ? e.score : '';
        tb.append('<tr><td>'+name+'</td><td>'+score+'</td></tr>');
      });
    }, function(e2,r2){ showErrStudents(r2); });
  });
}
// 加载推荐并展示原始数据（便于学习）
function loadRec(){ LW.rest('api/student', {action:'recommend'}, function(list){ var ul=$('#rec'); var empty=$('#rec-empty'); var raw=$('#rec-raw'); ul.empty(); if(!list || list.length===0){ empty.show(); raw.hide(); return; } empty.hide(); try{ raw.text('推荐原始数据:\n'+JSON.stringify(list,null,2)).show(); }catch(err){ raw.hide(); }
  (list||[]).forEach(function(c){ var name=c && (c.name||c.title||c.courseName); var credit=(c && (c.credit||c.credits)); ul.append('<li>'+(name||'未知')+'('+(credit!=null?credit:'未识别')+'学分)</li>'); }); }, function(e,r){ showErrStudents(r); }); }
// 导出成绩为 CSV（后端返回文件路径）
$('#btn-export').on('click', function(){ LW.rest('api/student', {action:'grades_export'}, function(data){ $('#export-link').html('<a href="'+data.file+'" target="_blank">下载CSV</a>'); }, function(e,r){ showErrStudents(r); }); });
// 页面加载：并行加载课表、成绩与推荐
$(function(){ loadCal(); loadGrades(); loadRec(); });
</script>
</body>
</html>